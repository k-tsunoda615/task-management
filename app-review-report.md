# タスク管理アプリ レビューレポート

## アプリ概要

Nuxt 4（Vue 3 + TypeScript）で構築されたタスク管理Webアプリケーション。バックエンドにSupabase（認証 + PostgreSQL）、状態管理にPinia、UIフレームワークにTailwind CSS + Nuxt UIを使用している。

主な画面は**カンバンボード**、**リストビュー**、**タスク詳細（ノート）**、**アナリティクス**、**管理者ダッシュボード**の5つ。AIチャット機能（Gemini API連携）も搭載している。

---

## 機能一覧

| 機能 | 説明 |
|------|------|
| **認証** | メール/パスワード、匿名ログイン、Google OAuth。匿名→正規ユーザーへの昇格フローあり |
| **カンバンボード** | Priority / Next / Archived の3カラム。ドラッグ&ドロップでステータス変更・並び替え |
| **リストビュー** | テーブル形式の一覧表示。ソート、フィルター、複数選択、ドラッグ並び替え対応 |
| **タスク詳細** | タイトル・メモ・ステータス編集、ファイル添付、タイマー計測 |
| **タイマー** | ブラウザ内ストップウォッチ。タブタイトルに経過時間表示。ページ遷移時に確認ダイアログ |
| **タグ管理** | カラー付きタグの作成・編集・削除。タグによるフィルタリング |
| **検索** | タイトル・メモ全文検索 + タグフィルター |
| **AIチャット** | Gemini API連携のフローティングチャット。タイトル自動生成機能 |
| **アナリティクス** | ステータス分布・時間分布・タグ分布のChart.jsグラフ |
| **管理者ダッシュボード** | ユーザーメトリクス一覧（管理者権限チェック付き） |
| **オンボーディング** | 新規ユーザー向けサンプルデータ自動作成 |
| **自動同期** | フォーカス復帰・ページ可視化・定期ポーリングによるデータ自動更新 |
| **GTMトラッキング** | Google Tag Manager連携によるイベント計測 |
| **LP（A/Bテスト）** | ランディングページ2バリアント |

---

## 技術スタック

- **フロントエンド**: Nuxt 4, Vue 3.5, TypeScript, Pinia, Tailwind CSS, Nuxt UI
- **バックエンド**: Supabase (Auth + PostgreSQL + Storage)
- **AI**: Google Gemini API (gemini-2.5-flash)
- **テスト**: Playwright (E2E)
- **その他**: dayjs, Chart.js, vuedraggable, DOMPurify, marked

---

## バグ・問題点まとめ

### 重大度: 高

#### 1. 管理者権限チェックのエラー判定が不正確
- **ファイル**: `app/pages/admin/index.vue` (178行目)
- **内容**: `err.message === "Forbidden"` で権限エラーを判定しているが、`useFetch` のエラーオブジェクトの `message` プロパティにそのまま "Forbidden" が入る保証がない。`statusCode === 403` で判定すべき。
- **影響**: 管理者以外のユーザーがアクセスした際に、権限不足ではなく一般エラーとして扱われる可能性がある。

#### 2. 認証ミドルウェアの保護範囲が不十分
- **ファイル**: `app/middleware/auth.ts` (12行目)
- **内容**: `/board` と `/list` のみ認証チェックしているが、`/analytics`、`/admin`、`/note/[id]` は保護されていない。
- **影響**: 未認証ユーザーがアナリティクスやノート画面に直接アクセスできてしまう。

#### 3. `calculateNewOrders` の無限再帰リスク
- **ファイル**: `app/utils/todoUtils.ts` (200-202行目)
- **内容**: `nextOrder - prevOrder <= 1` の場合に自分自身を再帰呼び出しするが、リストの状態が変わらないため無限ループになる可能性がある（10件超のリストでは別ロジックに分岐するため実際には発生しにくいが、理論上の問題）。
- **影響**: ブラウザがフリーズする可能性。

#### 4. 認証ミドルウェアのパス完全一致問題
- **ファイル**: `app/middleware/auth.ts` (12行目)
- **内容**: `to.path === "/board"` で完全一致チェックしているため、`/board/sub-page` のようなネストルートは保護されない。
- **影響**: ネストされたルートが追加された場合に認証バイパスが発生する。

### 重大度: 中

#### 5. 本番コードに `console.log` が残存
- **ファイル**: `app/middleware/auth.ts` (4行目)、`app/utils/todoUtils.ts` (複数箇所)、`server/api/gemini/models.get.ts`
- **内容**: デバッグ用の `console.log` が多数残っている。
- **影響**: パフォーマンスへの微小な影響と、ユーザーのブラウザコンソールにデバッグ情報が露出する。

#### 6. Gemini APIの入力バリデーション欠如
- **ファイル**: `server/api/gemini/chat.post.ts`
- **内容**: `prompt` や `message` フィールドの長さ制限やサニタイズ処理がない。
- **影響**: 極端に長い入力によるAPI費用の増大やDoSリスク。

#### 7. `useTodoSync` のエラーリカバリ不足
- **ファイル**: `app/composables/useTodoSync.ts`
- **内容**: `refresh()` が失敗した場合、`console.error` でログを出すだけでリトライやユーザー通知を行わない。
- **影響**: ネットワーク断などの一時的な障害後、ユーザーがデータ未同期に気づけない。

#### 8. テーブルの `colspan` 不一致
- **ファイル**: `app/pages/admin/index.vue` (80行目, 90行目)
- **内容**: `<thead>` のカラム数は4だが、`<tbody>` のローディング行・空行の `colspan` が `5` に設定されている。
- **影響**: テーブルのレイアウトが崩れる可能性がある。

### 重大度: 低

#### 9. `total_time` の型が不安定
- **ファイル**: `types/todo.ts`, `app/utils/todoUtils.ts`
- **内容**: `total_time` が `number | number[]` として扱われており、`normalizeTodo` で配列を数値に変換している。型定義で `number` に統一すべき。

#### 10. Supabaseダミー値のハードコード
- **ファイル**: `nuxt.config.ts` (48-49行目)
- **内容**: 環境変数未設定時に `"https://dummy.supabase.co"` と `"dummy-anon-key"` がフォールバックとして使われる。
- **影響**: 設定ミスに気づきにくい。本番環境で意図しないフォールバックが動作するリスク。

#### 11. `timer-guard.global.ts` で `confirm()` を使用
- **ファイル**: `app/plugins/timer-guard.global.ts`
- **内容**: ブラウザネイティブの `confirm()` ダイアログを使用しており、UIの一貫性がない。
- **影響**: UX品質の低下。Nuxt UIのモーダルに統一すべき。
